
<!DOCTYPE html>
<meta charset="utf-8"> <style> /* set the CSS */
	

	.x.axis path,
	.axis line {
	  display: none;
	}

	.line {
		fill: none; stroke: #2f6e57; stroke-width: 2px;
	} 

	div.tooltip {	
	    position: absolute;			
	    text-align: center;			
	    width: 120px;					
	    height: 60;					
	    padding: 2px;				
	    font: 12px calibri;	
	    color: white;	
	    background: #4c4f53;	
	    border: 1px;		
	    border-radius: 4px;			
	    pointer-events: none;			
	}

	.axisFormat line{
  		stroke: #4c4f53;
  		font: 10px calibri;
	}

	.axisFormat path{
  		stroke: #4c4f53;
  		font: 10px calibri;
	}

	.axisFormat text{
		font: 10px calibri;
  		fill: #4c4f53;
	}  

	</style>

<body>

<p>
  <label for="nLastDays" 
         style="display: inline-block; width: 600px; text-align: center">
         Select N last days range = <span id="nLastDays-value">...</span>
  </label>
  <input type="range" min="1" max="365" id="nLastDays">
</p>

<!-- load the d3.js library -->
	<script src="https://d3js.org/d3.v4.min.js"></script> 
	<script>

// set the dimensions and margins of the graph
	var margin = {top: 100, right: 50, bottom: 50, left: 50}, 
		width = 1200 - margin.left - margin.right,
		height = 500 - margin.top - margin.bottom;

// parse & format date / time
	var parseTime = d3.timeParse("%Y-%m-%d");
	var formatTime = d3.timeFormat("%B %d, %Y");


// set the ranges. Here's an amazing trick, helping to scale & revert vertical axis at once. Instead of calculating the difference between height and d.Data, height just needs to be declared as the down constraint of the y range.
	var x = d3.scaleTime().range([0, width]); 
	var y = d3.scaleLinear().range([height, 0]);

    // Define the axes
var xAxis = d3.axisBottom()
    .scale(x);

var yAxis = d3.axisLeft()
    .scale(y);

// define the line
	var valueline = d3.line()
		.curve(d3.curveMonotoneX)
		.x(function(d) { return x(d[0]); }) 
		.y(function(d) { return y(d[4]); });

// Define the div for the tooltip
var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);

// append the svg obgect to the body of the page // appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin 
	var svg = d3.select("body").append("svg")
    	.attr("width", width + margin.left + margin.right)
    	.attr("height", height + margin.top + margin.bottom)
  		.append("g")
    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

   var quandlData;

   d3.json("https://www.quandl.com/api/v3/datasets/GOOG/NASDAQ_TSLA.json?api_key=GdPU8brDtnPXP6AuZPqm", function(data) {
      var quandlData = data.dataset.data;

// format the data
	quandlData.forEach(function(d) { d[0] = parseTime(d[0]); d[4] = +d[4];
	});

// set a start date to filter with (last 365 days, then filter data)

	var cutoffDate = new Date();

	var nLastDaysInitial = 365;

	cutoffDate.setDate(cutoffDate.getDate() - nLastDaysInitial);

	quandlData = quandlData.filter(function(d) {
  		return d[0] > cutoffDate;
	})
 
// Scale the range of the data
	x.domain(d3.extent(quandlData, function(d) { return d[0]; })); 
	//y.domain([0, d3.max(quandlData, function(d) { return d[4]; })]);
	y.domain([
				d3.min(quandlData, function(d) { return d[4]; }), 
				d3.max(quandlData, function(d) { return d[4]; })
			]);


// Add the valueline path.
  	svg.append("path")
      .data([quandlData])
      .attr("class", "line")
      .attr("d", valueline);

	svg.selectAll("rect")	
       	.data(quandlData)			
    	.enter()
    	.append("rect")
    	.attr("x", function(d) { return x(d[0]); } )
    	.attr("y", 0)
    	.attr("width", width / nLastDaysInitial )
    	.attr("height", height)
       	.attr("fill", "#4c4f53")
       	.attr("fill-opacity", 0)	
        .on("mouseover", function(d) {	
        	d3.select(this)
        		.style("fill-opacity", .5);	
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div	.html(formatTime(d[0]) + "<br/>"  + d[4] + " $")	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            })					
        .on("mouseout", function(d) {
        	d3.select(this)
        		.style("fill", "#4c4f53")
        		.style("fill-opacity", 0);			
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });

 // Add the X Axis
  	svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .attr("class", "axisFormat")
      .call(d3.axisBottom(x));
 
 // Add the Y Axis
 	 svg.append("g")
 	  .attr("class", "axisFormat")
      .call(d3.axisLeft(y));

 // add title

 	svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 0 - (margin.top / 2))
        .attr("text-anchor", "middle")  
        .style("font-family", "calibri")
        .style("font-size", "25") 
        .style("fill", "#4c4f53")  
        .text("Tesla Motors Inc - last 365 days stock price");


     // Control nLastDays with slider
     
     //http://chimera.labs.oreilly.com/books/1230000000345/index.html

     	//http://www.d3noob.org/2014/04/using-html-inputs-with-d3js.html

     	//http://plnkr.co/edit/3a9emCPAEcVlR1o7YMg3?p=preview

     // when the input range changes update the circle 
		d3.select("#nLastDays").on("input", function() {
		  update(+this.value);
		});

		// Initial starting radius of the circle 
		update(365);

		// update the elements
		function update(nLastDays) {

		  // adjust the text on the range slider
		  d3.select("#nLastDays-value").text(nLastDays);
		  d3.select("#nLastDays").property("value", nLastDays);

		}

 } );

	</script>
</body>